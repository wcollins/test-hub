---
- name: Run 'show running-config' and visualize on Arista devices
  hosts: "{{ target | default('all') }}"
  gather_facts: false
  
  vars:
    timeout: 30
    output_dir: "{{ lookup('env', 'HOME') }}/arista_configs/command_outputs"  # Absolute path based on user's home directory
    html_output_dir: "{{ lookup('env', 'HOME') }}/arista_configs/html_reports"  # Absolute path for HTML reports
    
  tasks:
    - name: Ensure output directories exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      loop:
        - "{{ output_dir }}"
        - "{{ html_output_dir }}"
        
    - name: Run show running-config on Arista devices
      arista.eos.eos_command:
        commands: 
          - show running-config
      register: command_output
      vars:
        ansible_connection: network_cli
        ansible_network_os: arista.eos.eos
        ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
        ansible_host_key_checking: false
        ansible_become: true
        ansible_become_method: enable
        
    - name: Process configuration to make it pastable
      ansible.builtin.set_fact:
        clean_config: "{{ command_output.stdout[0] | regex_replace('^.*?!\n', '!', multiline=True) | regex_replace('ceos#
      
    - name: Display output file location
      ansible.builtin.debug:
        msg: "Output saved to {{ output_dir }}/{{ inventory_hostname }}_running_config_{{ ansible_date_time.iso8601_basic_short }}.txt"
, '') }}"
      
    - name: Save command output to file
      ansible.builtin.copy:
        content: "{{ clean_config }}"
        dest: "{{ output_dir }}/{{ inventory_hostname }}_running_config_{{ ansible_date_time.iso8601_basic_short }}.txt"
      delegate_to: localhost
      
    - name: Display output file location
      ansible.builtin.debug:
        msg: "Output saved to {{ output_dir }}/{{ inventory_hostname }}_running_config_{{ ansible_date_time.iso8601_basic_short }}.txt"